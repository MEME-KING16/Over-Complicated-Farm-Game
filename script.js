let ico = {
    wheat: `<svg height="17px" width="17px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 511.997 511.997" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path style="fill:#FEE187;" d="M197.859,96.901c0-15.533,6.049-30.137,17.033-41.121l41.12-41.12l41.12,41.12 c22.674,22.674,22.674,59.567,0,82.241l-41.12,41.121l-41.12-41.121C203.908,127.038,197.859,112.435,197.859,96.901z"></path> <path style="fill:#FEE187;" d="M314.106,144.403h58.154v58.154c0,32.066-26.087,58.154-58.154,58.154h-58.153v-58.154 C255.952,170.493,282.04,144.403,314.106,144.403z"></path> <path style="fill:#FEE187;" d="M197.89,436.627c-32.066,0-58.153-26.088-58.153-58.154v-58.154h58.153 c32.066,0,58.154,26.088,58.154,58.154v58.154H197.89z"></path> </g> <path style="fill:#FFC61B;" d="M314.106,275.372c40.149,0,72.814-32.664,72.814-72.814v-58.154c0-8.096-6.565-14.659-14.659-14.659 h-51.277c13.78-27.311,9.297-61.549-13.482-84.33l-41.12-41.12C263.629,1.545,259.901,0,256.013,0 c-3.888,0-7.616,1.545-10.366,4.294l-41.121,41.12C190.774,59.166,183.2,77.45,183.2,96.901c0,11.604,2.716,22.784,7.811,32.843 h-51.273c-8.095,0-14.659,6.563-14.659,14.659v58.154c0,40.149,32.663,72.814,72.812,72.814c8.095,0,14.659-6.563,14.659-14.659 c0-8.096-6.565-14.659-14.659-14.659c-23.981,0-43.493-19.512-43.493-43.495v-43.495h43.493c9.677,0,18.623,3.18,25.856,8.545 l9.093,9.093c5.03,6.78,8.13,15.07,8.5,24.052c-0.015,0.603-0.045,1.199-0.045,1.805v58.154c0,0.306,0.028,0.605,0.045,0.907v58.459 c-12.137-9.054-27.177-14.422-43.449-14.422h-58.153c-8.095,0-14.659,6.563-14.659,14.659v58.154 c0,40.149,32.663,72.814,72.812,72.814h43.449v46.054c0,8.096,6.565,14.659,14.659,14.659c8.095,0,14.659-6.563,14.659-14.659 v-59.806c0.019-0.302,0.045-0.601,0.045-0.907V378.47c0-0.605-0.031-1.204-0.045-1.805c0.95-23.149,20.07-41.69,43.448-41.69H357.6 v43.495c0,23.983-19.512,43.495-43.495,43.495c-8.095,0-14.659,6.563-14.659,14.659s6.565,14.659,14.659,14.659 c40.149,0,72.814-32.664,72.814-72.814v-58.154c0-8.096-6.565-14.659-14.659-14.659h-58.154c-16.271,0-31.311,5.367-43.448,14.421 V275.37h43.448V275.372z M357.599,202.559c0,23.983-19.512,43.495-43.495,43.495h-43.401v-43.495c0-0.605-0.031-1.204-0.045-1.805 c0.366-8.941,3.443-17.194,8.431-23.957l9.256-9.256c7.215-5.323,16.125-8.478,25.76-8.478h43.495V202.559z M225.258,66.147 l30.754-30.754l30.754,30.754c16.958,16.958,16.958,44.552,0,61.51l-17.951,17.951c-4.313,3.436-8.225,7.35-11.663,11.663 l-1.141,1.142l-1.278-1.278c-3.375-4.215-7.207-8.047-11.421-11.421l-18.056-18.058c-8.215-8.214-12.738-19.136-12.738-30.754 S217.042,74.36,225.258,66.147z M154.397,378.473v-43.495h43.493c23.377,0,42.498,18.541,43.449,41.69 c-0.015,0.603-0.045,1.199-0.045,1.805v43.495h-43.402C173.908,421.967,154.397,402.456,154.397,378.473z"></path> </g></svg>`,
    infectedwheat: `<svg height="17px" width="17px" version="1.1" id="Layer_1" class="infected" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 511.997 511.997" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path style="fill:#FEE187;" d="M197.859,96.901c0-15.533,6.049-30.137,17.033-41.121l41.12-41.12l41.12,41.12 c22.674,22.674,22.674,59.567,0,82.241l-41.12,41.121l-41.12-41.121C203.908,127.038,197.859,112.435,197.859,96.901z"></path> <path style="fill:#FEE187;" d="M314.106,144.403h58.154v58.154c0,32.066-26.087,58.154-58.154,58.154h-58.153v-58.154 C255.952,170.493,282.04,144.403,314.106,144.403z"></path> <path style="fill:#FEE187;" d="M197.89,436.627c-32.066,0-58.153-26.088-58.153-58.154v-58.154h58.153 c32.066,0,58.154,26.088,58.154,58.154v58.154H197.89z"></path> </g> <path style="fill:#FFC61B;" d="M314.106,275.372c40.149,0,72.814-32.664,72.814-72.814v-58.154c0-8.096-6.565-14.659-14.659-14.659 h-51.277c13.78-27.311,9.297-61.549-13.482-84.33l-41.12-41.12C263.629,1.545,259.901,0,256.013,0 c-3.888,0-7.616,1.545-10.366,4.294l-41.121,41.12C190.774,59.166,183.2,77.45,183.2,96.901c0,11.604,2.716,22.784,7.811,32.843 h-51.273c-8.095,0-14.659,6.563-14.659,14.659v58.154c0,40.149,32.663,72.814,72.812,72.814c8.095,0,14.659-6.563,14.659-14.659 c0-8.096-6.565-14.659-14.659-14.659c-23.981,0-43.493-19.512-43.493-43.495v-43.495h43.493c9.677,0,18.623,3.18,25.856,8.545 l9.093,9.093c5.03,6.78,8.13,15.07,8.5,24.052c-0.015,0.603-0.045,1.199-0.045,1.805v58.154c0,0.306,0.028,0.605,0.045,0.907v58.459 c-12.137-9.054-27.177-14.422-43.449-14.422h-58.153c-8.095,0-14.659,6.563-14.659,14.659v58.154 c0,40.149,32.663,72.814,72.812,72.814h43.449v46.054c0,8.096,6.565,14.659,14.659,14.659c8.095,0,14.659-6.563,14.659-14.659 v-59.806c0.019-0.302,0.045-0.601,0.045-0.907V378.47c0-0.605-0.031-1.204-0.045-1.805c0.95-23.149,20.07-41.69,43.448-41.69H357.6 v43.495c0,23.983-19.512,43.495-43.495,43.495c-8.095,0-14.659,6.563-14.659,14.659s6.565,14.659,14.659,14.659 c40.149,0,72.814-32.664,72.814-72.814v-58.154c0-8.096-6.565-14.659-14.659-14.659h-58.154c-16.271,0-31.311,5.367-43.448,14.421 V275.37h43.448V275.372z M357.599,202.559c0,23.983-19.512,43.495-43.495,43.495h-43.401v-43.495c0-0.605-0.031-1.204-0.045-1.805 c0.366-8.941,3.443-17.194,8.431-23.957l9.256-9.256c7.215-5.323,16.125-8.478,25.76-8.478h43.495V202.559z M225.258,66.147 l30.754-30.754l30.754,30.754c16.958,16.958,16.958,44.552,0,61.51l-17.951,17.951c-4.313,3.436-8.225,7.35-11.663,11.663 l-1.141,1.142l-1.278-1.278c-3.375-4.215-7.207-8.047-11.421-11.421l-18.056-18.058c-8.215-8.214-12.738-19.136-12.738-30.754 S217.042,74.36,225.258,66.147z M154.397,378.473v-43.495h43.493c23.377,0,42.498,18.541,43.449,41.69 c-0.015,0.603-0.045,1.199-0.045,1.805v43.495h-43.402C173.908,421.967,154.397,402.456,154.397,378.473z"></path> </g></svg>`,
    air: "â¬›",
    growingwheat: `ðŸŸ©`,
    infectedgrowingwheat: `ðŸŸ©`
}

let crops = ["wheat"]
let items = [new Item("wheat"),new Item("wheatseeds", "wheat seeds")]

let cropselected = "wheat"

class Err {
    constructor(msg) {
        this.msg = msg
    }
    throw() {
        let msg = this.msg
        new Toast({
            message: `This is an error! When reporting to the devs pleas hit Contorl + Shift + I and click console copy all of that and add it below as the decription.`,
            type: 'danger',
            customButtons: [
              {
                text: 'Report to the devs',
                onClick: function() {
                  window.open('https://github.com/MEME-KING16/Over-Complicated-Farm-Game/issues/new?labels=bug&title='+((msg+" "+"V:"+game.version).split(" ").join("+")));
                }
              }
            ]
          });
    }
}
function makeArray(w, h, val) {
    var arr = [];
    for(let i = 0; i < h; i++) {
        arr[i] = [];
        for(let j = 0; j < w; j++) {
            arr[i][j] = val;
        }
    }
    return arr;
}

function makeGrid(array,index) {
    const table = document.createElement('div');
    table.className = "field"
    for (let i = 0; i < array.length; i++) {
        const tr = document.createElement('tr');

        for (let j = 0; j < array[i].length; j++) {
            const cell = array[i][j];
            const td = document.createElement('td');
            if (cell.type == "air") {
                td.innerHTML = `<span class="empty">${cell.ico}</span>`;
            } else {
                td.innerHTML = `<span class="crop">${cell.ico}</span>`; 
            }

            td.addEventListener("click",() => {
                let type = game.fields[index].grid[i][j].type;
                if (type == "air" && game.wheatseeds >0 && cropselected == "wheat") {
                    game.fields[index].grid[i][j] = new Crop("growingwheat");
                    if(Achievements["The Welcoming Wheat"] == 0) {
                        Grant("The Welcoming Wheat")
                    }
                    if(game.stats.lifetimewheat.amount > 100 && Achievements["Dedicated Wheat Harvester"] == 0)
                        Grant("Dedicated Wheat Harvester")

                    game.wheatseeds = game.wheatseeds - 1
                    Advancement.checkAll()
                    update()
                } else if (type != "air" && game.fields[index].grid[i][j].type.split("growing")[0] != "") {
                    game[type] += 1;
                    game.stats["lifetime"+type] += 1
                    game.xp += 15
                    game.fields[index].grid[i][j] = new Crop("air");
                    Advancement.checkAll()
                    lvlcheck()
                    lvlprogupdate()
                    update()
                } else if (type == "air" && game[cropselected+"seeds"] > 0) {
                    game.fields[index].grid[i][j] = new Crop("growing"+cropselected);
                    game[cropselected+"seeds"] = game[cropselected+"seeds"] - 1
                    Advancement.checkAll()
                    update()
                }
            });

            tr.appendChild(td);
        }

        table.appendChild(tr);
    }

    return table;
}

function capitalizeFirstLetter(val) {
    return String(val).charAt(0).toUpperCase() + String(val).slice(1);
}

function getDisplayName(id) {
    const item = items.find(obj => obj.id === id);
    return item ? (item.displayName || item.id) : null;
}

class Field {
    constructor() {
        this.grid = makeArray(20,5,new Crop("air"))
        this.critters = makeArray(20,5,new Critter("air"))
    }
}

class Critter {
    constructor(type) {
        this.type = type
        this.time = 0
    }
}

class Crop {
    constructor(type) {
        this.type = type
        this.infected = false
        this.ico = ico[this.infected? "infected":""+type]
        if (type != 'air')
        this.growthstate = 0
    }
    update() {
        if (this.type != 'air')
        this.ico = ico[this.infected? "infected":""+this.type]
    }
}

let game = {
    money: 100,
    fieldcount:0,
    fields:[],
    wheatseeds:10,
    wheat:0,
    lvl:0,
    xp:0,
    xpreq:100,
    version:"Over-Complicated-Farm-Game-v0.2.0-rc.2",
    something:0,
    stats:{
        lifetimewheat: new Stat("lifetimeWheat","Lifetime Wheat")
    }
}

let prices = {
    wheat: {
        buy:0.5,
        sell:0.2
    },
    wheatseeds: {
        buy:0.1,
        sell:0.01,
    }
}

let gameloop = setInterval(() => {
    /*for (let index = 0; index < game.fields.length; index++) {
        for (let i = 0; i < game.fields[index].length; i++) {
            for (let j = 0; j < game.fields[index].grid[i].length; j++) {
                console.log(game.fields[index].grid[i][j])                
            }
        }
        
    }*/

    if(game.lvl < 21) {
        if (game.fieldcount > 0) {
        if(rng(0.03)) {
            let rn = Math.floor(Math.random() * ((game.fieldcount-1) - 0 + 1)) + 0
            console.log("SPAWN")
            let rng1 = Math.floor(Math.random() * ((game.fields[rn].critters.length-1) - 0 + 1)) + 0
            let rng2 = Math.floor(Math.random() * ((game.fields[rn].critters[rng1].length-1) - 0 + 1)) + 0
            let wormcount = game.fields[rn].critters.filter((critter) => critter == 'worm')
            if(wormcount < 3) {
            game.fields[rn].critters[rng1][rng2] = new Critter("worm")
            game.fields[rn].grid[rng1][rng2].infected = true
            game.fields[rn].grid[rng1][rng2].update()
            update()
            }     
            }
    }
    }
}, 100);

let CritterLoop = setInterval(() => {
    for (let index = 0; index < game.fields.length; index++) {
        for (let i = 0; i < game.fields[index].critters.length; i++) {
            for (let j = 0; j < game.fields[index].critters[i].length; j++) {
                if (game.fields[index].critters[i][j].type != 'air') {
                    game.fields[index].critters[i][j].time = game.fields[index].critters[i][j].time + 1
                }

                if(game.fields[index].critters[i][j].type == "worm" && game.fields[index].critters[i][j].time == 5) {
                    game.fields[index].critters[i][j] = new Critter("air")
                    game.fields[index].grid[i][j] = new Crop("air");
                    update()
                }
            }
        }
    }
},1000)

let CropLoop = setInterval(() => {
    for (let index = 0; index < game.fields.length; index++) {
        for (let i = 0; i < game.fields[index].grid.length; i++) {
            for (let j = 0; j < game.fields[index].grid[i].length; j++) {
                if (game.fields[index].grid[i][j].type != 'air') {
                    game.fields[index].grid[i][j].growthstate = game.fields[index].grid[i][j].growthstate + 1
                }

                if(game.fields[index].grid[i][j].type.split("growing")[0] == "" && game.fields[index].grid[i][j].growthstate > 9) {
                    game.fields[index].grid[i][j] = new Crop(game.fields[index].grid[i][j].type.split("growing")[1]);
                    update()
                }
            }
        }
    }
}, 1000);

function buy() {
    const fp = 100;
    if (game.money >= fp + (fp/10)*game.fieldcount) {
        game.money = game.money - (fp + (fp/10)*game.fieldcount);
    game.fieldcount += 1;
    game.fields.push(new Field())
    update();
    new Toast({
        message: 'You Bought a field!',
        type: 'success'
      });
    } else {
        new Toast({
            message: "You dont have enough money you need $"+((fp + (fp/10)*game.fieldcount) - game.money)+" more.",
            type: 'danger'
          });
    }
}

function update() {
    for (let index = 0; index < game.fieldcount; index++) {
        
    }
    document.getElementById("money").innerHTML = game.money;
    document.getElementById("fields").innerHTML = ""
    for (let index = 0; index < game.fields.length; index++) {
        document.getElementById("fields").appendChild(makeGrid(game.fields[index].grid,index))
    }
}

function inpadd(amt) {
    if (Number(document.getElementById("inp").value) + amt < 0) {
        document.getElementById("inp").value = 0
    } else {
    document.getElementById("inp").value = Number(document.getElementById("inp").value) + amt 
    }
}

function shopbuy(item) {
    let amt = Number(document.getElementById("inp").value)
    if (game.money < (prices[item].buy * amt)) {
        new Toast({
            message: "You dont have enough money you need $"+ (prices[item].buy * amt)-game.money +" more.",
            type: 'danger'
          });
    } else {
    game.money = Number((game.money - (prices[item].buy * amt)).toFixed(2))
    game[item] = game[item] + amt
    }
    update()
}

function shopsell(item) {
    let amt = Number(document.getElementById("inp").value)
    if (amt > game[item]) {
        new Toast({
            message: "You dont have enough "+item+" you have "+game[item],
            type: 'danger'
          });
    } else {
    game.money = Number((game.money + (prices[item].sell * amt)).toFixed(2))
    game[item] = game[item] - amt
    }
    update()
}

function shopbuymax(item) {
    let amt = Number(Math.floor(game.money/prices[item].buy))
    game.money = Number((game.money - (prices[item].buy * amt)).toFixed(2))
    game[item] = game[item] + amt
    update()
}

function shopsellmax(item) {
    let amt = Number(game[item])
    game.money = Number((game.money + (prices[item].sell * amt)).toFixed(2))
    game[item] = game[item] - amt
    update()
}

function store(open) {
    if (open == true) {
    document.getElementById("game").style.display = "none"
    document.getElementById("store").style.display = "block"
    document.getElementById("items").style.display = "block"
    } else if (open == false) {
        document.getElementById("game").style.display = "block"
        document.getElementById("store").style.display = "none"
        document.getElementById("items").style.display = "none"
    } else {
        new Err(`Param open is (${open}) but expected boolean`).throw()
    }
}
function storetransaction(item) {
    if(item == "Close") {
        document.getElementById("storetransaction").style.display = "none"
        document.getElementById("items").style.display = "block"
    } else if (prices[item] != undefined) {
        document.getElementById("storetransaction").style.display = "block"
        document.getElementById("items").style.display = "none"
        document.getElementById("iname").innerHTML = capitalizeFirstLetter(getDisplayName(item))
        document.getElementById("buyp").innerHTML = "Buy: "+prices[item].buy
        document.getElementById("sellp").innerHTML = "Sell: "+prices[item].sell
        document.getElementById("buysellbuttons").innerHTML = `<button onclick="shopbuy('${item}')">Buy</button><button onclick="shopsell('${item}')">Sell</button><button onclick="shopbuymax('${item}')">Buy MAX</button><button onclick="shopsellmax('${item}')">Sell MAX</button>`
    } else {
        new Err(`Unknown item:${item}`).throw() 
    }
}

function openInventory() {
    document.getElementById("game").style.display = "none"
    document.getElementById("inventory").style.display = "block"
    let cont = ""
    for (let index = 0; index < items.length; index++) {
        cont += capitalizeFirstLetter((items[index].displayName || items[index].id)) +": "+game[items[index].id] + "<br>"
    }
    document.getElementById("inventoryCont").innerHTML = cont
}

function closeInventory() {
    document.getElementById("game").style.display = "block"
    document.getElementById("inventory").style.display = "none"
    document.getElementById("inventoryCont").innerHTML = ""
}

function openStats() {
    document.getElementById("game").style.display = "none"
    document.getElementById("stats").style.display = "block"
    document.getElementById("stats").innerHTML = ""
    Object.entries(game.stats).forEach(([key, { amount, displayName }]) => {
        document.getElementById("stats").innerHTML += `${displayName}: ${amount}</br>`
      });
      document.getElementById("stats").innerHTML += `<button onclick="closeStats()">Back</button>`
}

function closeStats() {
    document.getElementById("game").style.display = "block"
    document.getElementById("stats").style.display = "none"
}

function lvlcheck() {
    if(game.xp >= game.xpreq) {
        game.xp = game.xp - game.xpreq
        game.xpreq = game.xpreq + game.xpreq * 0.1
        game.lvl = game.lvl + 1
        new Toast({
            message: "You leveled up to level "+game.lvl+"!",
            type: 'success'
          });
          game.money = game.money + 10
          document.getElementById('lvl').innerHTML = game.lvl
          update()
    }
}

function lvlprogupdate() {
    document.getElementById("xp").value = game.xp
    document.getElementById("xp").max = game.xpreq
}

function rng(dropChance) {
    if (Math.random() < dropChance) {
        return true;
    } else {
        return false;
    }
}

function fillAll() {
    for (let index = 0; index < game.fields.length; index++) {
        for (let i = 0; i < game.fields[index].grid.length; i++) {
            for (let j = 0; j < game.fields[index].grid[i].length; j++) {
                game.fields[index].grid[i][j] = new Crop("wheat")             
            }
        }
}
update()
}


document.getElementById("Level").addEventListener("mousedown",()=>{
    game.something = game.something + 1
    if(game.something > 2) {
        window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ")
    }
    setTimeout(() => {
        game.something = 0
    }, 3000);
})

new CropType("carrots","ðŸŸ§","ðŸŸ§","ðŸŸ©","ðŸŸ©",1,0.4,0.2,0.02)
for (let index = 0; index < crops.length; index++) {
    document.getElementById("cropsel").innerHTML += `<option value="${crops[index]}">${capitalizeFirstLetter(crops[index])}</option>`
}
